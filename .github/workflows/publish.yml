name: Publish to NPM

on:
  push:
      branches:
            - master
                paths-ignore:
                      - '**.md'
                            - 'docs/**'
                                  - 'examples/**'
                                        - '.github/**'
                                          workflow_dispatch:
                                              inputs:
                                                    version_type:
                                                            description: 'Version bump type'
                                                                    required: true
                                                                            default: 'patch'
                                                                                    type: choice
                                                                                            options:
                                                                                                      - patch
                                                                                                                - minor
                                                                                                                          - major
                                                                                                                          
                                                                                                                          jobs:
                                                                                                                            publish:
                                                                                                                                runs-on: ubuntu-latest
                                                                                                                                    permissions:
                                                                                                                                          contents: write
                                                                                                                                                id-token: write
                                                                                                                                                    
                                                                                                                                                        steps:
                                                                                                                                                              - name: Checkout code
                                                                                                                                                                      uses: actions/checkout@v4
                                                                                                                                                                              with:
                                                                                                                                                                                        fetch-depth: 0
                                                                                                                                                                                                  token: ${{ secrets.GITHUB_TOKEN }}
                                                                                                                                                                                                        
                                                                                                                                                                                                              - name: Setup Node.js
                                                                                                                                                                                                                      uses: actions/setup-node@v4
                                                                                                                                                                                                                              with:
                                                                                                                                                                                                                                        node-version: '18'
                                                                                                                                                                                                                                                  registry-url: 'https://registry.npmjs.org'
                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                              - name: Configure Git
                                                                                                                                                                                                                                                                      run: |
                                                                                                                                                                                                                                                                                git config user.name "GitHub Actions Bot"
                                                                                                                                                                                                                                                                                          git config user.email "actions@github.com"
                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                      - name: Install dependencies
                                                                                                                                                                                                                                                                                                              run: npm ci
                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                          - name: Run tests
                                                                                                                                                                                                                                                                                                                                  run: npm test
                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                              - name: Run linter
                                                                                                                                                                                                                                                                                                                                                      run: npm run lint
                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                  - name: Check current version
                                                                                                                                                                                                                                                                                                                                                                          id: current_version
                                                                                                                                                                                                                                                                                                                                                                                  run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                              - name: Bump version
                                                                                                                                                                                                                                                                                                                                                                                                      id: bump_version
                                                                                                                                                                                                                                                                                                                                                                                                              run: |
                                                                                                                                                                                                                                                                                                                                                                                                                        VERSION_TYPE="${{ github.event.inputs.version_type || 'patch' }}"
                                                                                                                                                                                                                                                                                                                                                                                                                                  NEW_VERSION=$(npm version $VERSION_TYPE --no-git-tag-version)
                                                                                                                                                                                                                                                                                                                                                                                                                                            echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
                                                                                                                                                                                                                                                                                                                                                                                                                                                      echo "Bumped version from ${{ steps.current_version.outputs.version }} to $NEW_VERSION"
                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                  - name: Update CHANGELOG
                                                                                                                                                                                                                                                                                                                                                                                                                                                                          run: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    DATE=$(date +%Y-%m-%d)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              VERSION="${{ steps.bump_version.outputs.new_version }}"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        echo -e "## $VERSION - $DATE\n\n- Automated release\n\n$(cat CHANGELOG.md)" > CHANGELOG.md
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    - name: Commit version bump
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            run: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      git add package.json CHANGELOG.md
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                git commit -m "chore: bump version to ${{ steps.bump_version.outputs.new_version }}"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          git tag ${{ steps.bump_version.outputs.new_version }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    git push origin master --tags
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                - name: Publish to NPM
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        run: npm publish
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                env:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      - name: Create GitHub Release
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              uses: actions/create-release@v1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      env:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        with:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  tag_name: ${{ steps.bump_version.outputs.new_version }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            release_name: Release ${{ steps.bump_version.outputs.new_version }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      body: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ## Changes in ${{ steps.bump_version.outputs.new_version }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          Published to npm: https://www.npmjs.com/package/react-native-ble-mesh/v/${{ steps.bump_version.outputs.new_version }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    draft: false
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              prerelease: false
